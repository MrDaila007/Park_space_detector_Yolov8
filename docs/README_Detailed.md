# Parking Detector v2.0 - Подробная документация

## Содержание

1. [Обзор системы](#обзор-системы)
2. [Архитектура](#архитектура)
3. [Установка и настройка](#установка-и-настройка)
4. [Использование](#использование)
5. [API Reference](#api-reference)
6. [Конфигурация](#конфигурация)
7. [Устранение неполадок](#устранение-неполадок)
8. [Примеры использования](#примеры-использования)

## Обзор системы

### Основные возможности

Parking Detector v2.0 - это продвинутая система компьютерного зрения для мониторинга парковочных мест в реальном времени. Система использует YOLO (You Only Look Once) для детекции объектов и интеллектуальные алгоритмы для определения занятости парковочных мест.

#### Ключевые особенности:

- **Универсальное распознавание** - работает с любыми типами объектов
- **Интерактивное управление** - создание, редактирование и удаление парковочных мест
- **Интеллектуальный анализ** - учет пограничных состояний и частых срабатываний
- **Отслеживание времени** - статистика использования парковочных мест
- **Гибкая конфигурация** - настройка всех параметров через JSON

### Технические характеристики

- **Модель детекции**: YOLOv8 Nano/Small/Medium
- **Поддерживаемые форматы видео**: MP4, AVI, RTSP, USB-камеры
- **Разрешение**: любое (автоматическое масштабирование)
- **Производительность**: 30+ FPS на современном оборудовании
- **Точность**: 95%+ для четко видимых парковочных мест

## Архитектура

### Компоненты системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Video Input   │───▶│  YOLO Detector  │───▶│  Object Filter  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Visualization  │◀───│  State Manager  │◀───│  Space Analyzer │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                       ┌─────────────────┐
                       │  Time Tracker   │
                       └─────────────────┘
```

### Алгоритм работы

1. **Захват кадра** - получение изображения с видеопотока
2. **Детекция объектов** - YOLO находит все объекты в кадре
3. **Фильтрация** - отбор релевантных объектов по классам
4. **Анализ пересечений** - вычисление перекрытия с парковочными местами
5. **Определение состояния** - классификация занятости
6. **Отслеживание времени** - накопление статистики
7. **Визуализация** - отрисовка результатов

## Установка и настройка

### Системные требования

#### Минимальные требования:
- Python 3.8+
- 4GB RAM
- OpenCV 4.0+
- 2GB свободного места

#### Рекомендуемые требования:
- Python 3.9+
- 8GB+ RAM
- CUDA-совместимая видеокарта (для ускорения)
- SSD накопитель

#### Поддержка устройств:
- **CPU**: Полная поддержка, работает на любом компьютере
- **CUDA**: Автоматическое определение и использование при наличии
- **Автоматический режим**: Система сама выбирает оптимальное устройство

### Установка зависимостей

```bash
# Установка из requirements.txt
pip install -r requirements.txt

# Или установка вручную
pip install opencv-python numpy ultralytics torch torchvision Pillow
```

### Первоначальная настройка

1. **Скачивание модели YOLO** (автоматически при первом запуске)
2. **Создание конфигурации** (автоматически создается `config/settings.json`)
3. **Настройка видеопотока** в коде

## Использование

### Запуск программы

```bash
cd src
python parking_detector.py
```

### Создание парковочных мест

1. Запустите программу
2. Дождитесь загрузки видео
3. Кликайте по углам каждого парковочного места (4 точки)
4. Нажмите `S` для сохранения

### Редактирование парковочных мест

1. Нажмите `E` для входа в режим редактирования
2. Кликните по месту, которое хотите изменить
3. Перерисуйте точки в новых позициях
4. Нажмите `S` для сохранения изменений

### Удаление парковочных мест

1. Нажмите `R` для входа в режим удаления
2. Кликайте по местам, которые нужно удалить
3. Нажмите `S` для сохранения изменений

## API Reference

### Основные функции

#### `format_time(seconds)`
Форматирует время в удобном формате.

**Параметры:**
- `seconds` (float): время в секундах

**Возвращает:**
- `str`: отформатированная строка времени

**Примеры:**
```python
format_time(45)      # "45s"
format_time(150)     # "2.5m"
format_time(3600)    # "1.0h"
format_time(90000)   # "1d 1.0h"
```

#### `check_frequent_detections(space_idx, current_time, threshold, window)`
Проверяет частые срабатывания в парковочном месте.

**Параметры:**
- `space_idx` (int): индекс парковочного места
- `current_time` (float): текущее время
- `threshold` (int): порог количества срабатываний
- `window` (float): временное окно в секундах

**Возвращает:**
- `bool`: True если есть частые срабатывания

#### `check_parking_spaces(...)`
Основная функция проверки парковочных мест.

**Параметры:**
- `parking_spaces` (list): список парковочных мест
- `detections` (list): детектированные объекты
- `tracked_objects` (list): отслеживаемые классы
- `threshold` (float): порог занятости
- `uncertainty_threshold` (float): порог пограничного состояния
- `universal_detection` (bool): универсальное распознавание
- `uncertainty_tracking` (dict): отслеживание пограничных состояний
- `uncertainty_time_threshold` (float): время для "вероятно занято"
- `free_time_tracking` (dict): отслеживание времени свободности
- `occupied_time_tracking` (dict): отслеживание времени занятости
- `frequent_detection_threshold` (int): порог частых срабатываний
- `frequent_detection_window` (float): временное окно для частых срабатываний

**Возвращает:**
- `list`: список состояний мест

### Конфигурационные функции

#### `save_config(config, file)`
Сохраняет конфигурацию в JSON файл.

#### `load_config(file)`
Загружает конфигурацию из JSON файла.

#### `save_parking_spaces(spaces, file)`
Сохраняет парковочные места в JSON файл.

#### `load_parking_spaces(file)`
Загружает парковочные места из JSON файла.

## Конфигурация

### Файл настроек (config/settings.json)

```json
{
  "universal_detection": true,
  "occupancy_threshold": 0.6,
  "uncertainty_threshold": 0.3,
  "uncertainty_time_threshold": 3.0,
  "frequent_detection_threshold": 10,
  "frequent_detection_window": 10.0,
  "tracked_objects": [2, 67]
}
```

### Описание параметров

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `universal_detection` | bool | true | Универсальное распознавание всех объектов |
| `occupancy_threshold` | float | 0.6 | Порог занятости (60% перекрытия) |
| `uncertainty_threshold` | float | 0.3 | Порог пограничного состояния (30% перекрытия) |
| `uncertainty_time_threshold` | float | 3.0 | Время для перехода в "вероятно занято" (секунды) |
| `frequent_detection_threshold` | int | 10 | Количество срабатываний для частых детекций |
| `frequent_detection_window` | float | 10.0 | Временное окно для частых срабатываний (секунды) |
| `tracked_objects` | list | [2, 67] | ID классов объектов для отслеживания |

### Настройка видеопотока

В файле `src/parking_detector.py`:

```python
# Локальное видео
video_path = '/path/to/your/video.mp4'

# Веб-камера (первая доступная)
video_path = 0

# IP-камера
video_path = 'http://192.168.1.100:8080/video'

# RTSP поток
video_path = 'rtsp://user:password@ip:port/stream'
```

### Настройка устройства обработки

#### Автоматическое определение (рекомендуется)
```json
{
  "device": "auto",
  "force_cpu": false
}
```

#### Принудительное использование CPU
```json
{
  "device": "cpu",
  "force_cpu": true
}
```

#### Принудительное использование CUDA
```json
{
  "device": "cuda",
  "force_cpu": false
}
```

#### Производительность по устройствам

| Устройство | Скорость | Точность | Потребление памяти |
|------------|----------|----------|-------------------|
| **CPU** | 5-15 FPS | 95%+ | 2-4 GB |
| **CUDA** | 30+ FPS | 95%+ | 1-2 GB |
| **Авто** | Оптимальная | 95%+ | Адаптивная |

## Устранение неполадок

### Частые проблемы

#### 1. Ошибка CUDA
```
RuntimeError: CUDA out of memory
```

**Решение:**
- Уменьшите разрешение видео
- Используйте YOLOv8n вместо YOLOv8s
- Закройте другие приложения, использующие GPU

#### 2. Низкая производительность
**Симптомы:** Медленная обработка кадров

**Решения:**
- Используйте YOLOv8n (самая быстрая модель)
- Уменьшите разрешение видео
- Включите CUDA ускорение
- Закройте фоновые приложения

#### 3. Неточная детекция
**Симптомы:** Ложные срабатывания или пропуски

**Решения:**
- Настройте `occupancy_threshold` (попробуйте 0.5-0.7)
- Используйте более точную модель YOLO
- Улучшите освещение
- Проверьте качество видео

#### 4. Проблемы с мышью
**Симптомы:** Не работает создание/редактирование мест

**Решения:**
- Убедитесь, что окно активно
- Проверьте, что курсор находится в области видео
- Перезапустите программу

### Логи и отладка

#### Включение режима отладки
Нажмите клавишу `D` для включения режима отладки. В этом режиме:
- Отображаются все детектированные объекты
- Показываются классы объектов
- Можно добавлять новые классы в отслеживание

#### Проверка конфигурации
```python
# Проверка загруженной конфигурации
print(f"Detection mode: {'Universal' if universal_detection else 'Cars only'}")
print(f"Occupancy threshold: {occupancy_threshold}")
print(f"Tracked objects: {tracked_objects}")
```

## Примеры использования

### Пример 1: Мониторинг парковки

```python
# Настройка для мониторинга парковки
config = {
    "universal_detection": False,  # Только автомобили
    "occupancy_threshold": 0.7,    # 70% для уверенности
    "uncertainty_threshold": 0.4,  # 40% для пограничного состояния
    "uncertainty_time_threshold": 5.0,  # 5 секунд для "вероятно занято"
    "frequent_detection_threshold": 8,   # 8 срабатываний
    "frequent_detection_window": 8.0,    # за 8 секунд
    "tracked_objects": [2, 3, 5, 7]  # car, motorcycle, bus, truck
}
```

### Пример 2: Детекция всех объектов

```python
# Настройка для универсальной детекции
config = {
    "universal_detection": True,   # Все объекты
    "occupancy_threshold": 0.5,    # 50% для чувствительности
    "uncertainty_threshold": 0.2,  # 20% для раннего обнаружения
    "uncertainty_time_threshold": 2.0,  # 2 секунды
    "frequent_detection_threshold": 5,   # 5 срабатываний
    "frequent_detection_window": 5.0,    # за 5 секунд
    "tracked_objects": []  # Все объекты
}
```

### Пример 3: Высокая точность

```python
# Настройка для максимальной точности
config = {
    "universal_detection": False,
    "occupancy_threshold": 0.8,    # 80% для высокой уверенности
    "uncertainty_threshold": 0.5,  # 50% для четкого разделения
    "uncertainty_time_threshold": 10.0,  # 10 секунд для стабильности
    "frequent_detection_threshold": 15,  # 15 срабатываний
    "frequent_detection_window": 15.0,   # за 15 секунд
    "tracked_objects": [2]  # Только автомобили
}
```

## Производительность

### Оптимизация для разных сценариев

#### Высокая скорость (30+ FPS)
- YOLOv8n модель
- Разрешение 640x480
- CUDA ускорение
- Минимальные настройки детекции

#### Высокая точность (95%+)
- YOLOv8s/m модель
- Разрешение 1280x720+
- Тщательная настройка порогов
- Качественное освещение

#### Сбалансированный режим
- YOLOv8n модель
- Разрешение 800x600
- Стандартные настройки
- CUDA ускорение

### Мониторинг производительности

Система автоматически отображает:
- FPS обработки
- Количество детектированных объектов
- Статистику парковочных мест
- Время обработки кадра

## Лицензия

MIT License - см. файл LICENSE для подробностей.

## Поддержка

Для получения поддержки:
1. Проверьте раздел "Устранение неполадок"
2. Изучите примеры использования
3. Создайте issue в репозитории проекта

---

**Версия документации:** 2.0  
**Последнее обновление:** 2024  
**Автор:** Parking Detector Team
